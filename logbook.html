<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Logbook - Bitefinder</title>
	<link rel="icon" type="image/x-icon" href="images/icon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: white; }
        .header-font { font-family: 'Montserrat', sans-serif; }
        .card-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5), 0 0 30px rgba(59, 130, 246, 0.3); }
        .btn-glow:hover { box-shadow: 0 0 10px rgba(96, 165, 250, 0.8), 0 0 20px rgba(96, 165, 250, 0.6); }
        select, input, textarea {
             background-color: #1f2937;
             border-color: #4b5563;
        }
        /* Custom file input */
        input[type="file"]::file-selector-button {
             background-color: #3b82f6; border: none; padding: 0.5rem 1rem;
             border-radius: 0.375rem; color: white; font-weight: 600; cursor: pointer;
             transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #2563eb; }
        
        .log-card { background-color: #1f2937; border: 1px solid #4b5563; } /* Updated */
        .custom-scroll { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #4a5568 #2d3748; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #2d3748; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 2px solid #2d3748; }
        #addNewEntryCard {
            display: flex; align-items: center; justify-content: center;
            min-height: 400px; background-color: #374151;
            border: 2px solid #4b5563; border-radius: 0.5rem;
            color: #9ca3af; transition: all 0.2s ease-in-out;
        }
        #addNewEntryCard:hover { border-color: #60a5fa; color: white; }

        /* Copied Styles (Unchanged) */
        .selection-btn {
            transition: all 0.2s ease-in-out; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100%; padding: 0.75rem;
            background-color: #374151; border: 2px solid #4B5563; border-radius: 0.5rem; color: #D1D5DB;
        }
        .selection-btn:hover { border-color: #60a5fa; color: white; }
        .selection-btn.active { background-color: #3b82f6; border-color: #60a5fa; color: white; }
        #logWeatherSelector .selection-btn.active { background-color: #0891b2; border-color: #22d3ee; }
        #logClaritySelector .selection-btn.active { background-color: #059669; border-color: #34d399; }
        #logTempSelector .selection-btn.active { background-color: #0f766e; border-color: #14b8a6; }
        .selection-btn img { transition: all 0.2s ease-in-out; opacity: 0.4; }
        .selection-btn:hover img, .selection-btn.active img { opacity: 1; }
        .selection-btn svg { transition: all 0.2s ease-in-out; fill: #9ca3af; }
        .selection-btn:hover svg, .selection-btn.active svg { fill: white; }
        .fish-selector-scroll {
            display: flex; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 1rem; scrollbar-width: thin; scrollbar-color: #4a5568 #2d3748;
        }
        .fish-selector-scroll::-webkit-scrollbar { height: 8px; }
        .fish-selector-scroll::-webkit-scrollbar-track { background: #2d3748; border-radius: 10px; }
        .fish-selector-scroll::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 2px solid #2d3748; }
        .fish-selector-scroll > button { flex: 0 0 auto; width: 120px; height: 130px; }
        .lure-select-row { border: 2px solid transparent; transition: all 0.2s ease-in-out; cursor: pointer; }
        .lure-select-row:hover { background-color: #374151; }
        .lure-select-row.selected { border-color: #60a5fa; background-color: #1e40af; }
        .category-header { position: sticky; top: -1px; background-color: #1f2937; z-index: 10; }
        .color-picker-label { transition: all 0.2s ease-in-out; }
        .color-picker-label:hover { filter: brightness(1.25); }
        .color-picker-label input[type="radio"]:checked ~ .check-indicator { opacity: 1; }
        .color-picker-label input[type="radio"]:checked ~ .content-wrapper .fake-checkbox { background-color: #3b82f6; border-color: #60a5fa; }
        .color-picker-label input[type="radio"]:checked ~ .content-wrapper .fake-checkbox::after {
            content: ''; display: block; width: 9px; height: 9px; background: white; border-radius: 50%; margin: 2px 0 0 2px;
        }
    </style>
</head>
<body class="p-4">

<div class="bg-gray-800 border border-blue-500/50 rounded-2xl p-4 sm:p-6 max-w-6xl w-full space-y-6 card-glow mx-auto">
    
    <div class="flex flex-wrap justify-between items-center gap-4">
         <img src="images/bitefinderlogbook_logo.png" alt="Bitefinder Logo" class="h-14 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/250x50/1f2937/FFFFFF?text=Logbook';">
    </div>
    
    <div id="logbook-display-container">
        <div id="logbook-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <p id="logbookLoading" class="text-gray-400 col-span-full text-center py-20">Loading your logbook from the cloud...</p>
        </div>
    </div>
</div>

    <div id="logEntryModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 rounded-lg p-6 border border-gray-600 max-w-3xl w-full card-glow flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 id="logModalTitle" class="text-lg font-semibold text-white">New Log Entry</h3>
                <button type="button" id="closeLogModalBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow min-h-0 custom-scroll pr-2 space-y-6">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="logDate" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="logDate" class="w-full rounded-lg text-sm" required>
                    </div>
                    <div>
                        <label for="logLocation" class="block text-sm font-medium text-gray-300 mb-1">Location (Lake or River)</label>
                        <input type="text" id="logLocation" placeholder="e.g., Lake Simcoe, West Bay" class="w-full rounded-lg text-sm" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Species Caught</label>
                    <div id="logSpeciesSelector" class="fish-selector-scroll gap-3 bg-gray-800 p-2 rounded-lg">
                        </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Lure Used</label>
                        <div id="logLureSelector" class="border border-gray-600 rounded-lg bg-gray-800 custom-scroll h-72">
                            </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Lure Color</label>
                        <div id="logColorSelector" class="border border-gray-700 rounded-lg bg-gray-800 custom-scroll h-72 p-2 space-y-2">
                            </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Weather</label>
                    <div id="logWeatherSelector" class="grid grid-cols-4 gap-3">
                        </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Water Clarity</label>
                        <div id="logClaritySelector" class="grid grid-cols-2 gap-3">
                            </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Water Temp</label>
                        <div id="logTempSelector" class="grid grid-cols-2 gap-3">
                            </div>
                    </div>
                </div>

                 <div>
                    <label for="logNotes" class="block text-sm font-medium text-gray-300 mb-1">Notes (size, pattern, etc.)</label>
                    <textarea id="logNotes" rows="3" placeholder="e.g., Caught 4 pounder on the deep weed edge. Bite was subtle." class="w-full rounded-lg text-sm"></textarea>
                </div>

                <div class="space-y-3 p-4 bg-gray-800 rounded-lg border border-blue-500/50">
                    <h4 class="font-semibold text-lg text-blue-300">Share to Social Feed</h4>
                    <p class="text-sm text-gray-400">Want to share this catch? Add a photo and check the box below to post it to the public gallery.</p>
                     <div>
                        <label for="logImageUpload" class="block text-sm font-medium text-gray-300 mb-1">Upload Photo</label>
                        <input type="file" id="logImageUpload" class="w-full rounded-lg text-sm text-gray-400 border border-gray-600" accept="image/png, image/jpeg">
                    </div>
                    <div class="flex items-center space-x-3">
                         <input type="checkbox" id="makePostPublic" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                         <label for="makePostPublic" class="text-sm font-medium text-gray-200">Make this post public?</label>
                    </div>
                 </div>
                 </div>
            
            <div class="flex-shrink-0 flex items-center justify-between gap-4 mt-6 pt-4 border-t border-gray-700">
                <div id="saveSpinner" class="hidden">
                    <p class="text-sm text-blue-400 animate-pulse">Uploading post, please wait...</p>
                </div>
                 <div class="flex items-center gap-4">
                    <button type="button" id="cancelLogBtn" class="text-gray-400 hover:text-white text-sm">Cancel</button>
                    <button type="button" id="saveLogBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg btn-glow text-sm">
                        Save Entry
                    </button>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg p-6 border border-red-500/50 max-w-sm w-full card-glow">
            <h3 id="confirmTitle" class="text-lg font-semibold text-white mb-2">Confirm Deletion</h3>
            <p id="confirmMessage" class="text-gray-400 text-sm mb-6">Are you sure you want to delete this log entry?</p>
            <div class="flex items-center justify-end gap-4"><button id="confirmCancelBtn" class="text-gray-400 hover:text-white text-sm font-medium py-2 px-4">Cancel</button><button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg btn-glow text-sm">Confirm</button></div>
        </div>
    </div>

    <script src="shared-data.js"></script>
    <script src="app-data.js"></script> 
    
    <script src="supabase-client.js"></script>
    <script src="auth-manager.js"></script>
    <script src="data-manager-v2.js"></script>

    <script>
        // Store current user state globally on this page
        let currentUserId = null; 
        let currentUsername = 'Angler'; // Default username

        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Data ---
            let myFishingLog = []; // This will be loaded from Supabase
            let logEntryToDelete = null;
            let newLogSelections = { species: null, lure: null, color: null, weather: null, clarity: null, temp: null };

            // --- Element Selectors (Same as Firebase version) ---
            const logbookDisplay = document.getElementById('logbook-display');
            const logbookContainer = document.getElementById('logbook-display-container');
            const logEntryModal = document.getElementById('logEntryModal');
            const logModalTitle = document.getElementById('logModalTitle');
            const cancelLogBtn = document.getElementById('cancelLogBtn');
            const closeLogModalBtn = document.getElementById('closeLogModalBtn');
            const saveLogBtn = document.getElementById('saveLogBtn');
            const saveSpinner = document.getElementById('saveSpinner');
            const logDate = document.getElementById('logDate');
            const logLocation = document.getElementById('logLocation');
            const logNotes = document.getElementById('logNotes');
            const logSpeciesSelector = document.getElementById('logSpeciesSelector');
            const logLureSelector = document.getElementById('logLureSelector');
            const logColorSelector = document.getElementById('logColorSelector');
            const logWeatherSelector = document.getElementById('logWeatherSelector');
            const logClaritySelector = document.getElementById('logClaritySelector');
            const logTempSelector = document.getElementById('logTempSelector'); 
            const logImageUpload = document.getElementById('logImageUpload');
            const makePostPublic = document.getElementById('makePostPublic');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');


            // --- REPLACED: Core Data Functions now use Supabase via data-manager.js ---
            async function saveLogToSupabaseDB() {
                 if (!currentUserId) {
                    console.warn("No user, saving to fallback localStorage");
                 }
                 await saveLogToSupabase(currentUserId, myFishingLog); // from data-manager.js
                 console.log("Logbook saved to Supabase.");
            }

            async function loadLogFromSupabaseDB() {
                if (!currentUserId) return;
                const userData = await fetchUserData(currentUserId); // from data-manager.js
                myFishingLog = userData.fishingLog || [];
            }
            // --- END REPLACEMENT ---

            
            // --- Component Builder & UI Functions (Unchanged from original) ---
            function createSelectionButtons(container, data, dataKey, selectionStateKey, imageClass = 'w-10 h-10') {
                container.innerHTML = '';
                for (const key in data) {
                    const item = data[key];
                    const button = document.createElement('button');
                    button.type = 'button'; 
                    button.className = 'selection-btn';
                    button.dataset[dataKey] = key;
                    button.innerHTML = `${item.imageSrc ? `<img src="${item.imageSrc}" alt="${item.name}" class="${imageClass} mx-auto mb-1 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/1E293B/FFFFFF?text=?';">` : ''}<span class="text-sm font-medium">${item.name}</span>`;
                    button.addEventListener('click', () => {
                        newLogSelections[selectionStateKey] = key;
                        container.querySelectorAll('.selection-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                    container.appendChild(button);
                }
            }
            function populateLureListSelect(targetElement) {
                targetElement.innerHTML = '';
                for (const cat in displayLures) {
                    const h = document.createElement('h4'); 
                    h.className = 'category-header font-bold text-sm text-blue-300 p-2 pt-3'; 
                    h.textContent = cat; 
                    targetElement.appendChild(h);
                    displayLures[cat].forEach(ln => {
                        const li = canonicalLureMap[ln]; if (!li) return;
                        const r = document.createElement('button');
                        r.type = 'button'; 
                        r.className = 'lure-select-row w-full p-2 rounded-lg flex flex-col items-center text-left'; 
                        r.dataset.lureName = ln;
                        r.innerHTML = `<img src="${li.image}" alt="${ln}" class="h-16 w-full object-contain bg-white rounded-md mb-2" onerror="this.onerror=null;this.src='https://placehold.co/100x64/111827/4B5563?text=?';"><span class="text-sm font-medium text-white text-center">${ln}</span>`;
                        targetElement.appendChild(r);
                    });
                }
            }
            function populateColorSelect(targetElement) {
                targetElement.innerHTML = '';
                const sortedCategories = Object.keys(baseColorCategories).sort();
                const lightColorsWithBlackText = ['White', 'Yellow', 'Pink', 'Silver', 'Gold', 'Orange'];
                for (const categoryName of sortedCategories) {
                    const categoryInfo = baseColorCategories[categoryName];
                    const representativeHex = baseColorHexMap[categoryName] || '#374151'; 
                    const textColorClass = lightColorsWithBlackText.includes(categoryName) ? 'text-black' : 'text-white';
                    const label = document.createElement('label');
                    label.className = 'color-picker-label relative block p-2.5 rounded-md cursor-pointer border-2 border-transparent';
                    label.style.backgroundColor = representativeHex;
                    label.style.filter = 'brightness(90%)'; 
                    label.innerHTML = `
                        <input type="radio" name="logColorRadio" value="${categoryName}" class="absolute opacity-0 w-full h-full inset-0 z-20 cursor-pointer">
                        <div class="check-indicator absolute inset-0 rounded-md border-4 border-blue-400 ring-2 ring-blue-300 opacity-0 transition-opacity z-10 pointer-events-none"></div>
                        <div class="content-wrapper relative z-0 flex items-start space-x-3 pointer-events-none ${textColorClass}">
                            <div class="fake-checkbox w-5 h-5 rounded-full border-2 ${textColorClass === 'text-black' ? 'border-gray-700' : 'border-gray-300'} bg-transparent/50 flex-shrink-0 mt-0.5"></div>
                            <div>
                                <span class="text-sm font-semibold">${categoryName}</span>
                                <p class="text-xs opacity-80">${categoryInfo.description}</p>
                            </div>
                        </div>`;
                    targetElement.appendChild(label);
                }
                const radioStyle = document.createElement('style');
                radioStyle.innerHTML = `.color-picker-label input[type="radio"]:checked ~ .content-wrapper .fake-checkbox { background-color: #3b82f6; border-color: #60a5fa; } .color-picker-label input[type="radio"]:checked ~ .check-indicator { opacity: 1; } .color-picker-label input[type="radio"]:checked ~ .content-wrapper .fake-checkbox::after { content: ''; display: block; width: 9px; height: 9px; background: white; border-radius: 50%; margin: 2px 0 0 2px; }`;
                document.head.appendChild(radioStyle);
            }
            function resetSelections() {
                newLogSelections = { species: null, lure: null, color: null, weather: null, clarity: null, temp: null };
                document.querySelectorAll('#logEntryModal .selection-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('#logEntryModal .lure-select-row').forEach(btn => btn.classList.remove('selected'));
                document.querySelectorAll('#logColorSelector input[type="radio"]').forEach(radio => radio.checked = false);
                logImageUpload.value = '';
                makePostPublic.checked = false;
            }
            function openLogModal() {
                resetSelections(); 
                logLocation.value = '';
                logNotes.value = '';
                logDate.valueAsDate = new Date(); 
                logModalTitle.textContent = "New Log Entry";
                logEntryModal.classList.remove('hidden');
            }
            function closeLogModal() {
                logEntryModal.classList.add('hidden');
            }

            // --- MODIFIED: saveLogEntry() is now async and handles public Supabase posts ---
            async function saveLogEntry() {
                let missing = [];
                if (!newLogSelections.species) missing.push('Species');
                if (!newLogSelections.lure) missing.push('Lure');
                if (!newLogSelections.color) missing.push('Color');
                if (!newLogSelections.weather) missing.push('Weather');
                if (!newLogSelections.clarity) missing.push('Clarity');
                if (!newLogSelections.temp) missing.push('Water Temp'); 
                if (!logLocation.value) missing.push('Location');
                if (missing.length > 0) {
                    alert('Please fill out all required fields: ' + missing.join(', '));
                    return;
                }

                const wantsPublicPost = makePostPublic.checked;
                const imageFile = logImageUpload.files[0];

                if (wantsPublicPost && !imageFile) {
                    alert("Please select an image to upload for a public post, or uncheck the 'Make public' box.");
                    return;
                }
                
                saveLogBtn.disabled = true;
                saveSpinner.classList.remove('hidden');
                saveSpinner.textContent = "Saving private log...";

                // 1. Create the PRIVATE log entry object
                const newEntry = {
                    id: Date.now(), 
                    date: logDate.value,
                    location: logLocation.value,
                    notes: logNotes.value,
                    species: newLogSelections.species,
                    lure: newLogSelections.lure,
                    color: newLogSelections.color,
                    weather: newLogSelections.weather,
                    clarity: newLogSelections.clarity,
                    temp: newLogSelections.temp 
                };

                try {
                    // 2. Add to local array and save the PRIVATE logbook to Supabase
                    myFishingLog.push(newEntry);
                    await saveLogToSupabaseDB();

                    // 3. (NEW) Handle the PUBLIC post IF checked
                    if (wantsPublicPost && imageFile) {
                        console.log("Attempting to create public social post...");
                        saveSpinner.textContent = "Uploading photo and posting...";
                        // Use the function from data-manager.js, passing in the user ID and name
                        await createPublicSocialPost(newEntry, imageFile, currentUserId, currentUsername);
                        console.log("Public post created successfully!");
                    }

                    // 4. Success: Re-render, close modal, and re-enable button
                    renderLogEntries();
                    closeLogModal();

                } catch (err) {
                    console.error("Error saving entry or uploading post:", err);
                    alert("An error occurred: " + err.message);
                } finally {
                    saveLogBtn.disabled = false;
                    saveSpinner.classList.add('hidden');
                }
            }

            function showDeleteConfirm(entryId) {
                logEntryToDelete = entryId;
                confirmTitle.textContent = "Confirm Log Deletion";
                confirmMessage.textContent = "Are you sure you want to permanently delete this log entry?";
                confirmOkBtn.textContent = "Delete Entry";
                confirmModal.classList.remove('hidden');
            }
            function hideConfirmModal() {
                confirmModal.classList.add('hidden');
                logEntryToDelete = null;
            }

            // --- MODIFIED: deleteLogEntry() is now async ---
            async function deleteLogEntry() {
                if (logEntryToDelete === null) return;
                myFishingLog = myFishingLog.filter(entry => entry.id !== logEntryToDelete);
                await saveLogToSupabaseDB(); // MODIFIED
                renderLogEntries();
                hideConfirmModal();
            }

            // --- Render Log Entries function (Unchanged from original) ---
            function renderLogEntries() {
                logbookContainer.innerHTML = ''; // Clear container (which holds the loading msg)
                logbookDisplay.innerHTML = ''; // Clear display grid
                
                const sortedLog = [...myFishingLog].sort((a, b) => new Date(b.date) - new Date(a.date));
                if (sortedLog.length === 0) {
                    logbookDisplay.innerHTML = `<p class="text-gray-400 italic col-span-full text-center">Your logbook is empty. Click the "+" card to record your first catch!</p>`;
                }

                sortedLog.forEach(entry => {
                    const card = document.createElement('div');
                    card.className = 'log-card rounded-lg p-4 flex flex-col space-y-3';
                    const speciesInfo = fishTypes[entry.species] || { name: entry.species, imageSrc: 'images/icon.ico' }; 
                    const lureInfo = canonicalLureMap[entry.lure] || { image: 'images/icon.ico' }; 
                    const colorHex = baseColorHexMap[entry.color] || '#808080';
                    const weatherIcon = weatherTypes[entry.weather]?.imageSrc || ''; 
                    const clarityIcon = clarityTypes[entry.clarity]?.imageSrc || '';
                    const tempIcon = tempTypes[entry.temp]?.imageSrc || ''; 
                    card.innerHTML = `
                        <div class="flex items-center space-x-3 bg-gray-800 p-3 rounded-md">
                            <img src="${speciesInfo.imageSrc}" alt="${speciesInfo.name}" class="h-16 w-16 object-contain bg-white rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/64x64/FFFFFF/000000?text=?';">
                            <div>
                                <span class="text-xs uppercase text-gray-400">Species</span>
                                <h4 class="font-bold text-xl text-white">${speciesInfo.name}</h4>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 bg-gray-800 p-3 rounded-md">
                             <img src="${lureInfo.image}" alt="${entry.lure}" class="h-16 w-16 object-contain bg-white rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/64x64/FFFFFF/000000?text=?';">
                            <div>
                                <span class="text-xs uppercase text-gray-400">Catch Details</span>
                                <h4 class="font-bold text-lg text-white">${entry.lure}</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="w-4 h-4 rounded-full border border-gray-500" style="background-color: ${colorHex};"></span>
                                    <span class="text-sm text-gray-300">${entry.color}</span>
                                </div>
                            </div>
                        </div>
                        <div class="pt-2">
                            <div class="flex justify-between items-start">
                                 <div>
                                    <span class="font-bold text-lg text-blue-300">${entry.location || 'Unknown Location'}</span>
                                    <p class="text-sm font-semibold text-gray-300">${entry.date}</p>
                                 </div>
                                 <button class="delete-log-btn text-xs text-red-400 hover:text-red-300 flex-shrink-0 ml-2" data-id="${entry.id}">&times; Delete</button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-300 space-y-2 pt-3 border-t border-gray-700">
                            <p>${entry.notes || 'No notes for this entry.'}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                             <img src="${weatherIcon}" alt="${entry.weather}" class="h-6 w-6 opacity-70" title="Weather: ${entry.weather}" onerror="this.style.display='none'">
                             <img src="${clarityIcon}" alt="${entry.clarity}" class="h-6 w-6 opacity-70" title="Clarity: ${entry.clarity}" onerror="this.style.display='none'">
                             <img src="${tempIcon}" alt="${entry.temp}" class="h-6 w-6 opacity-70" title="Temp: ${entry.temp}" onerror="this.style.display='none'">
                        </div>
                    `;
                    logbookDisplay.appendChild(card);
                });
                const addCardHTML = `<button id="addNewEntryCard" title="Add New Log Entry"><svg class="h-20 w-20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4v16m8-8H4" /></svg></button>`;
                logbookDisplay.appendChild(addCardHTML);
            }


            // --- Event Listeners (Logic mostly unchanged) ---
            closeLogModalBtn.addEventListener('click', closeLogModal);
            cancelLogBtn.addEventListener('click', closeLogModal);
            logEntryModal.addEventListener('click', (e) => {
                if (e.target === logEntryModal) closeLogModal();
            });

            saveLogBtn.addEventListener('click', saveLogEntry); // MODIFIED: Calls async save function

            logbookDisplay.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-log-btn');
                const addBtn = e.target.closest('#addNewEntryCard');
                if (deleteBtn) {
                    const entryId = Number(deleteBtn.dataset.id);
                    showDeleteConfirm(entryId);
                    return; 
                }
                if (addBtn) {
                    openLogModal();
                    return;
                }
            });
            
            logLureSelector.addEventListener('click', (e) => {
                const row = e.target.closest('.lure-select-row');
                if (row) {
                    newLogSelections.lure = row.dataset.lureName;
                    logLureSelector.querySelectorAll('.lure-select-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                }
            });
            logColorSelector.addEventListener('click', (e) => {
                const radio = e.target.closest('input[type="radio"]');
                if(radio) {
                     newLogSelections.color = radio.value;
                }
            });
            confirmOkBtn.addEventListener('click', deleteLogEntry); // MODIFIED: Calls async delete
            confirmCancelBtn.addEventListener('click', hideConfirmModal);


            // --- NEW AUTH-BASED INIT FUNCTION ---
            async function pageInit() {
                // Build all the static modal components first
                createSelectionButtons(logSpeciesSelector, fishTypes, 'fish', 'species', 'w-20 h-20');
                createSelectionButtons(logWeatherSelector, weatherTypes, 'weather', 'weather');
                createSelectionButtons(logClaritySelector, clarityTypes, 'clarity', 'clarity');
                createSelectionButtons(logTempSelector, tempTypes, 'temp', 'temp'); 
                populateLureListSelect(logLureSelector);
                populateColorSelect(logColorSelector);
                
                // Add the auth listener. This listener also acts as our Auth Guard.
                supaClient.auth.onAuthStateChange(async (_event, session) => {
                    if (session && session.user) {
                        // User is logged in. Set their ID and load their cloud logbook.
                        const user = session.user;
                        currentUserId = user.id;
                        currentUsername = user.user_metadata.username || user.email; // Get the username we saved on signup

                        createHeader('logbook', session); // Create the "logged in" header

                        await loadLogFromSupabaseDB(); // Load their private log
                        
                        renderLogEntries(); // Render their log entries
                    } else {
                        // No user. This is a protected page. Enforce the login.
                        enforceLogin('index.html');
                    }
                });
            }
            pageInit();

        });
    </script>
</body>
</html>